// Copyright 2021 Yuhui.

// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at

//     https://www.apache.org/licenses/LICENSE-2.0

// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Cloudflare Web Analytics",
  "categories": [
    "ANALYTICS"
  ],
  "brand": {
    "id": "yuhui.sg-gtm-templates",
    "displayName": "Yuhui",
    "thumbnail": "data:image/png;base64,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\u003d"
  },
  "description": "Add Cloudflare Web Analytics snippet to your website. \u003ca href\u003d\"https://www.cloudflare.com/web-analytics\"\u003eLearn more.\u003c/a\u003e",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "token",
    "displayName": "Token",
    "simpleValueType": true,
    "help": "Enter the Cloudflare Web Analytics token, found in your snippet at { \"token\": \"[token value]\" }.",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      },
      {
        "type": "REGEX",
        "args": [
          "[0-9a-zA-Z]+"
        ]
      }
    ],
    "alwaysInSummary": true
  },
  {
    "type": "SELECT",
    "name": "enableSpa",
    "displayName": "Enable for Single Page Applications (SPAs)",
    "macrosInSelect": true,
    "selectItems": [
      {
        "value": true,
        "displayValue": "True"
      },
      {
        "value": false,
        "displayValue": "False"
      }
    ],
    "simpleValueType": true,
    "help": "By default, Cloudflare Web Analytics will measure SPAs automatically by overriding the History API\u0027s \"pushState\" function and listening to the \"onpopstate\". Choose \"False\" to disable this measurement. \u003ca href\u003d\"https://developers.cloudflare.com/analytics/web-analytics/getting-started/web-analytics-spa\"\u003eLearn more.\u003c/a\u003e",
    "notSetText": "This website is not a SPA"
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const tagName = 'Cloudflare Web Analytics: ';
const log = require('logToConsole');
log(tagName + 'tag data = ', data);

// 'token' must be present
if (!data.hasOwnProperty('token') || !data.token) {
  data.gtmOnFailure();
  return;
}

const encodeUriComponent = require('encodeUriComponent');
const injectScript = require('injectScript');
const queryPermission = require('queryPermission');

const baseUrl = 'https://static.cloudflareinsights.com/beacon.min.js';
// build parameters to use with beaconUrl
let params = [
  {
    key: 'token',
    value: data.token,
  }
];
if (data.hasOwnProperty('enableSpa') && !data.enableSpa) {
  params.push({
    key: 'spa',
    value: 'false',
  });
}
const paramsStr = params.map(function(param) {
  if (param.value) {
    return param.key + '=' + encodeUriComponent(param.value);
  }
}).join('&');

// if the script loaded successfully, log a message and signal success
const onSuccess = () => {
  log(tagName + 'tag loaded successfully.');
  data.gtmOnSuccess();
};

// if the script fails to load, log a message and signal failure
const onFailure = () => {
  log(tagName + 'tag load failed.');
  data.gtmOnFailure();
};

// build the final URL to use
let url = baseUrl + (paramsStr ? '?' + paramsStr : '');
log(tagName + 'tag URL = ' + url);

if (queryPermission('inject_script', url)) {
  injectScript(url, onSuccess, onFailure, url);
} else {
  log(tagName + 'tag load failed due to permissions mismatch.');
  data.gtmOnFailure();
}


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://static.cloudflareinsights.com/beacon.min.js*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: inject script without token
  code: |-
    const mockData = {
      token: '',
      enableSpa: true,
    };

    mock('injectScript', (url, onSuccess, onFailure) => {
      assertThat(url).isUndefined();
      onFailure();
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnFailure').wasCalled();
- name: inject script with token
  code: |-
    const mockData = {
      token: testToken,
    };

    mock('injectScript', (url, onSuccess, onFailure) => {
      assertThat(url).contains('token=' + testToken);
      assertThat(url).doesNotContain('spa=false');
      onSuccess();
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: inject script with token and spa
  code: |-
    const mockData = {
      token: testToken,
      enableSpa: false,
    };

    mock('injectScript', (url, onSuccess, onFailure) => {
      assertThat(url).contains('token=' + testToken);
      assertThat(url).contains('spa=false');
      onSuccess();
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
setup: const testToken = '42e216b9090ru59384ygu891dce9eecde';


___NOTES___

Created on 16/04/2021, 20:37:46


